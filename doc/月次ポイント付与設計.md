# 毎月定期ポイント配布機能の設計

## 概要
毎月1日午前0時（JST）に、対象ユーザーに対して自動でポイントを付与する機能。
対象ユーザーはprivilegedユーザー。pk=privileged-users,sk=privileged-usersで取得
ユーザー個別設定で0ポイントに設定されている場合は配布しない。

## DB設計

### 新規テーブル項目

#### 1. ポイント配布設定（point-allocation-config）
| PK | SK | 説明 |
|----|----|----|
| config#point-allocation | default | デフォルトポイント配布設定 |
| config#point-allocation | user#{userid} | ユーザー個別設定 |

**属性:**
- pk: `config#point-allocation`
- sk: `default` または `user#{userid}`
- dtype: `point-allocation-config`
- monthlyPoints: number（月次配布ポイント数）
- updatedAt: 更新日時

#### 2. ポイント配布履歴（point-allocation-history）
| PK | SK | 説明 |
|----|----|----|
| pt-alloc-hist#{yyyy-mm} | {userid}#{timestamp} | 月次配布履歴 |

**属性:**
- pk: `pt-alloc-hist#{yyyy-mm}`
- sk: `{userid}#{timestamp}`
- userId: 対象ユーザーID
- allocatedPoints: 配布ポイント数
- expirationDate: ポイント有効期限（月末24時）
- errorMessage: エラーメッセージ（失敗時のみ）
- createdAt: 実行日時

### 既存テーブル活用

#### ポイント残高（pt）
定期配布時も既存のポイント残高テーブルを使用：
- pk: `pt#{userid}`
- sk: ポイント有効期限（月末24時）
- balance: ポイント残高
- dtype: `pt`
- createdAt: 作成日時
- updatedAt: 更新日時

#### ポイント残高更新ログ（ptlog）
定期配布時のログも記録（既存の形式を使用）：
- pk: `ptlog#{userid}`
- sk: `{有効期限}#{作成日時}`
- balance: 更新後の残高
- additionalPoints: 配布ポイント数
- createdAt: 作成日時


## Lambda関数設計

### 定期実行用Lambda（scheduled-point-allocation）
- **トリガー**: EventBridge Rule（毎月1日午前0時JST）
- **ファイルパス**: `/backend-cdk/lambda/scheduled-point-allocation.py`
- **テスト機能**: `custom_expiration_days`パラメータで有効期限を指定可能
- **処理内容**:
  1. デフォルト設定を取得（pk=config#point-allocation, sk=default）
  2. privilegedユーザーリストを取得（pk=privileged-users, sk=privileged-users）
  3. 各ユーザーの個別設定を確認（pk=config#point-allocation, sk=user#{userid}）
  4. ポイント配布実行（0ポイント設定はスキップ）
  5. 履歴記録（pt-alloc-hist#{yyyy-mm}）

### EventBridge Rule設定
- **実行スケジュール**: 毎月末日15:00 UTC（翌月1日0:00 JST）
- **CDK設定**: `cdk_chatgpt_clone_stack_ap.ts`に追加済み


## ポイント有効期限の計算
```python
def get_month_end_expiration(custom_days=None):
    """月末24時の有効期限を計算
    
    Args:
        custom_days: テスト用のカスタム有効期限日数（指定がない場合は月末まで）
    
    Returns:
        有効期限のISO形式文字列
    """
    now = datetime.now(timezone("Asia/Tokyo"))
    
    if custom_days is not None:
        # テスト用: 指定日数後の23:59:59.999999
        expiration = now + timedelta(days=custom_days)
        expiration = expiration.replace(hour=23, minute=59, second=59, microsecond=999999)
    else:
        # 本番用: 月末の23:59:59.999999
        last_day = calendar.monthrange(now.year, now.month)[1]
        expiration = datetime(now.year, now.month, last_day, 23, 59, 59, 999999, tzinfo=timezone("Asia/Tokyo"))
    
    return expiration.strftime('%Y-%m-%d %H:%M:%S.%f')
```

## 初期設定・テスト方法

### デフォルト設定の作成
```python
# DynamoDBに直接登録
{
  "pk": "config#point-allocation",
  "sk": "default", 
  "dtype": "point-allocation-config",
  "monthlyPoints": 10000,
  "updatedAt": "2025-01-08 00:00:00"
}
```

### テスト実行
```bash
# 7日後を有効期限にする場合
aws lambda invoke \
  --function-name ${PROJECT_NAME}-scheduled-point-allocation \
  --cli-binary-format raw-in-base64-out \
  --payload '{"custom_expiration_days": 7}' \
  response.json

# 1分後を有効期限にする場合（分単位テスト用）
aws lambda invoke \
  --function-name ${PROJECT_NAME}-scheduled-point-allocation \
  --cli-binary-format raw-in-base64-out \
  --payload '{"custom_expiration_minutes": 1}' \
  response.json
```

